{% extends 'arbol_item.html' %}

{% block content %}

    <div class="title_right" style="background-color:#ccc">
        <div class="x_title">
            <a href='/expedientes/listado'><strong>LISTADO</strong></a> --

            <a href='/expedientes/modi/{{ expediente.id }}/'>
                <strong>EXPEDIENTE</strong>
            </a> --

            <strong>COMODATO</strong>
        </div>
    </div>

    <div class="clearfix"></div>

    <div class="row">
        <div class="col-md-6 col-sm-6 col-xs-12">
            <div class="x_panel">
                <div class="x_content">
                    <div class="form-group">
                            {{ form.etapa.errors }}
                            * Etapa: {{ form.etapa }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">


        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>COMODATO</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content" >

                <div id="divCompromisoOrdenado">
                    {% for msg in messages %}
                        <strong>{{msg}}</strong>
                        <br><br>
                    {% endfor %}

                        <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12">
                            {{ form.proveedor.errors }}
                            * Proveedor: {{ form.proveedor }}
                            </div>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                            {{form.resolucion_contratacion.errors}}
                            * Resolución de Contratación: {{ form.resolucion_contratacion}}<br>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12">
                            {{form.fecha_resolucion_contratacion.errors}}
                            * Fecha de Resolución: {{ form.fecha_resolucion_contratacion }}
                            </div>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                            {{form.numero_contratacion_directa.errors}}
                            * N° de Contratación Directa: {{ form.numero_contratacion_directa }}<br>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12">
                            {{form.importe.errors}}
                            * Importe: $ {{ form.importe }}<br>
                            </div>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                            {{form.orden_provision.errors}}
                            * Orden de Provisión: {{ form.orden_provision }}<br>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12">
                            {{form.resolucion_pago.errors}}
                            * Resolución de Pago: {{ form.resolucion_pago }}
                            </div>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                            {{form.fecha_resolucion_pago.errors}}
                            * Fecha Resolución de Pago: {{ form.fecha_resolucion_pago }}<br>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12">
                        {{form.solicitante_resolucion_pago.errors}}
                        * Solicitante Resolución Pago: {{ form.solicitante_resolucion_pago }}
                            </div>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                        {{form.fuente_financiamiento.errors}}
                        Fuente de Financiamiento: {{ form.fuente_financiamiento }}<br>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12">
                            {{form.observaciones.errors}}
                            Observaciones: {{ form.observaciones }}<br>
                            </div>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <center><button id="btnAgregar" onclick="agregar()" class="btn btn-primary">Agregar</button></center>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>


    </div>

                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_content">

                                    <table class="table" id="tabla_comodato" name="tabla_comodato">
                                        <thead>
                                            <tr>
                                                <th>Resolución Contratación</th>
                                                <th>N° Contratación Directa</th>
                                                <th>Importe</th>
                                                <th>Orden Provisión</th>
                                                <th>Resolución Pago</th>
                                                <th>Fecha Resolución Pago</th>
                                                <th>Solicitante R. Pago</th>
                                                <th>Observación</th>
                                            </tr>
                                        </thead>
                                        <tbody>

                                        </tbody>
                                    </table>

                                </div>
                            </div>
                        </div>




<form id="frm" action="" method="post">
                            {% csrf_token %}
        <input id="id_expediente" name="expediente" type="hidden" value="{{ expediente.id }}" />
        <input id="id_comodato" name="comodato" type="hidden" value="" />
        <center><button onclick="guardar()" id="btnGuardar" class="btn btn-primary">Guardar</button></center>
</form>



<script>

    $(document).ready(function()
    {
        {% if not form.errors %}
            $("#id_etapa").val({{expediente.etapa_id}});
            inicializar_controles();
        {% endif %}
    });


    $("#id_etapa").change(function()
    {
        inicializar_controles();
    });


    function inicializar_controles()
    {
        var etapa = $("#id_etapa").val();


        if ("{{expediente.estado.valor}}" == "CERRADO")
        {
            $("#id_etapa").prop("disabled", true);
            $("#btnGuardar").prop("disabled", true);
            $("#divCompromisoOrdenado").children().prop("disabled", true);
            return;
        }

        if (etapa == 4)
        {
            $("#divCompromisoOrdenado_left").children().prop("disabled", false);
            $("#divCompromisoOrdenado_right").children().prop("disabled", false);
            $("#btnGuardar").prop("disabled", false);
            $("#btnAgregar").prop("disabled", false);
        }
        else
        {
            $("#btnGuardar").prop("disabled", true);
            $("#btnAgregar").prop("disabled", true);
            $("#divCompromisoOrdenado_left").children().prop("disabled", true);
            $("#divCompromisoOrdenado_right").children().prop("disabled", true);
        }
    }


    function get_valores_iniciales(etapa)
    {
        $.ajax({
            url:"/expedientes/get_valores_iniciales/",
            cache: false,
            type: "GET",
            data: {tipo_expediente: "SERVICIO_MEDICO", etapa: etapa},
            success: function(request) {
                console.log(request);

                $("#id_orden_provision").val(request.orden_provision);
                $("#id_resolucion_pago").val(request.resolucion_pago);
            }
        });
    }


    function agregar()
    {
            row = '<tr>' +
            '<td>' + $("#id_resolucion_contratacion").val() + '</td>' +
            '<td>' + $("#id_numero_contratacion_directa").val() + '</td>' +
            '<td>' + $("#id_importe").val() + '</td>' +
            '<td>' + $("#id_orden_provision").val() + '</td>' +
            '<td>' + $("#id_resolucion_pago").val() + '</td>' +
            '<td>' + $("#id_fecha_resolucion_pago").val() + '</td>' +
            '<td>' + $("#id_solicitante_resolucion_pago option:selected").text() + '</td>' +
            '<td>' + $("#id_observaciones").val() + '</td>' +
            '</tr>';
            //alert(row);
            $('#tabla_comodato> tbody:last').append(row);
    }


    function guardar()
    {

    var comodato = "";
    var expediente, proveedor, fecha_resolucion_contratacion, fuente_financiamiento;
    var resolucion_contratacion, numero_contratacion_directa, importe;
    var orden_provision, resolucion_pago, fecha_resolucion_pago;
    var solicitante_resolucion_pago, observaciones;

    $("#tabla_comodato tbody tr").each(function (index)
        {

            $(this).children("td").each(function (index2)
            {
                switch (index2)
                {
                    case 0: resolucion_contratacion  = $(this).text();
                    break;
                    case 1: numero_contratacion_directa  = $(this).text();
                    break;
                    case 2: importe  = $(this).text();
                    break;
                    case 3: orden_provision  = $(this).text();
                    break;
                    case 4: resolucion_pago  = $(this).text();
                    break;
                    case 5: fecha_resolucion_pago = $(this).text();
                    break;
                    case 6: solicitante_resolucion_pago  = $(this).text();
                    break;
                    case 7: observaciones                = $(this).text();
                    break;
                }
            })

            expediente = $("#id_expediente").val();
            proveedor = $("#id_proveedor").val();
            fecha_resolucion_contratacion = $("#id_fecha_resolucion_contratacion").val();
            fuente_financiamiento = $("#id_fuente_financiamiento").val();

            comodato = comodato + " " + expediente  +
            ',' + proveedor +
            ',' + resolucion_contratacion +
            ',' + fecha_resolucion_contratacion +
            ',' + numero_contratacion_directa +
            ',' + importe +
            ',' + orden_provision +
            ',' + resolucion_pago +
            ',' + fecha_resolucion_pago +
            ',' + solicitante_resolucion_pago +
            ',' + fuente_financiamiento +
            ',' + observaciones;

            alert(comodato);

        })

    }



</script>
{% endblock %}